<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <title>记录本</title>
  <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
  <style>
    body {
      font-family: "微软雅黑", Arial, sans-serif;
      background: #f5f6fa;
      margin: 0;
      padding: 0;
    }
    .container {
      width: 90vw;
      max-width: none;
      min-width: 320px;
      margin: 4px auto; /* 原40px，改为16px，让标题栏更靠上 */
      padding: 24px;
      background: #fff;
      border-radius: 16px;
      box-shadow: 0 4px 24px rgba(0,0,0,0.08);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }
    h1 {
      text-align: center;
      margin-bottom: 32px;
      font-size: 2.5em;
      color: #222;
      letter-spacing: 2px;
    }
    .note-area {
      position: relative;
      width: 100%;
      height: 50vh;
      min-height: 120px;
      max-height: none;
      max-width: none;
      border: 2px solid #d1d8e0;
      border-radius: 12px;
      background: #fafbfc;
      cursor: text;
      overflow: auto;
      box-sizing: border-box;
      transition: height 0.2s;
      resize: both;
    }
    .note-text {
      position: absolute;
      white-space: pre-wrap;
      word-wrap: break-word;
      color: #333;
      font-size: 1.2em;
    }
    .input-box {
      position: absolute;
      border: none;
      outline: none;
      background: transparent;
      font-size: 1.2em;
      width: auto;
      min-width: 50px;
      max-width: 200px;
      padding: 4px 8px;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>
  <div id="app">
    <div class="container">
      <h1>笔记墙</h1>
      <div
        class="note-area"
        @click="handleAreaClick($event)"
        ref="noteArea"
      >
        <div
          v-for="(item, idx) in notes"
          :key="idx"
          class="note-text"
          :style="{left: item.x + 'px', top: item.y + 'px', visibility: (inputing && editingIdx === idx) ? 'hidden' : 'visible'}"
          @click.stop="editNote(idx, $event)"
        >
          {{ item.text }}
        </div>
        <input
          v-if="inputing"
          ref="inputBox"
          class="input-box"
          :style="{left: inputPos.x + 'px', top: inputPos.y + 'px'}"
          v-model="inputText"
          @blur="saveInput"
          @keyup.enter="saveInput"
        />
      </div>
    </div>
  </div>
  <script>
    const { createApp } = Vue;
    createApp({
      data() {
        return {
          notes: [],
          inputing: false,
          inputText: '',
          inputPos: { x: 0, y: 0 },
          editingIdx: null
        }
      },
      created() {
        // 页面加载时获取所有便签
        fetch('http://10.101.54.21:30000/api/notes')
          .then(res => res.json())
          .then(data => {
            this.notes = data.map(item => ({
              id: item.id,
              text: item.text,
              x: item.x,
              y: item.y
            }));
          });
      },
      methods: {
        handleAreaClick(e) {
          if (this.inputing) return;
          const rect = this.$refs.noteArea.getBoundingClientRect();
          this.inputPos = {
            x: e.clientX - rect.left,
            y: e.clientY - rect.top
          };
          this.inputText = '';
          this.inputing = true;
          this.editingIdx = null;
          this.$nextTick(() => {
            this.$refs.inputBox && this.$refs.inputBox.focus();
          });
        },
        editNote(idx, e) {
          if (this.inputing) return;
          const item = this.notes[idx];
          this.inputPos = { x: item.x, y: item.y };
          this.inputText = item.text;
          this.inputing = true;
          this.editingIdx = idx;
          this.$nextTick(() => {
            this.$refs.inputBox && this.$refs.inputBox.focus();
          });
        },
        saveInput() {
          if (this.inputText.trim()) {
            if (this.editingIdx !== null) {
              // 编辑已有
              const note = this.notes[this.editingIdx];
              fetch(`http://10.101.54.21:30000/api/notes/${note.id}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: this.inputText,
                  x: note.x,
                  y: note.y
                })
              })
                .then(res => res.json())
                .then(data => {
                  // 用后端返回的内容更新前端
                  this.notes[this.editingIdx].text = data.text;
                  this.notes[this.editingIdx].x = data.x;
                  this.notes[this.editingIdx].y = data.y;
                  this.inputing = false;
                  this.inputText = '';
                  this.editingIdx = null;
                });
              return;
            } else {
              // 新增
              fetch('http://10.101.54.21:30000/api/notes', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  text: this.inputText,
                  x: this.inputPos.x,
                  y: this.inputPos.y
                })
              })
                .then(res => res.json())
                .then(data => {
                  this.notes.push({
                    id: data.id,
                    text: data.text,
                    x: data.x,
                    y: data.y
                  });
                  this.inputing = false;
                  this.inputText = '';
                  this.editingIdx = null;
                });
              return;
            }
          }
          this.inputing = false;
          this.inputText = '';
          this.editingIdx = null;
        }
      }
    }).mount('#app');
  </script>
</body>
</html>
